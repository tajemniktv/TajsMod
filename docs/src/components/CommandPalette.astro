---
/**
 * Global Command Palette component
 * Opens with Ctrl+K / Cmd+K
 * Provides search across pages, features, FAQ, and quick actions
 */
import {
  searchIndex,
  searchItems,
  type SearchItem,
} from "../data/search-index";

const BASE_URL = import.meta.env.BASE_URL;

// Pre-categorize items for display
const categoryLabels = {
  page: "Pages",
  feature: "Features",
  faq: "FAQ",
  action: "Quick Actions",
  changelog: "Changelog",
};
---

<!-- Command Palette Backdrop -->
<div
  id="command-palette-backdrop"
  class="fixed inset-0 z-[9998] bg-black/50 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-200"
  aria-hidden="true"
>
</div>

<!-- Command Palette Dialog -->
<div
  id="command-palette"
  class="fixed inset-0 z-[9999] items-start justify-center pt-[15vh] hidden"
  role="dialog"
  aria-modal="true"
  aria-label="Command palette"
>
  <div
    class="w-full max-w-xl mx-4 bg-white dark:bg-dark-800 rounded-2xl shadow-2xl border border-gray-200 dark:border-dark-700 overflow-hidden"
  >
    <!-- Search Input -->
    <div
      class="flex items-center gap-3 px-4 py-3 border-b border-gray-200 dark:border-dark-700"
    >
      <svg
        class="w-5 h-5 text-gray-400"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
      </svg>
      <input
        id="palette-search"
        type="text"
        placeholder="Search pages, features, FAQ..."
        class="flex-1 bg-transparent outline-none text-gray-900 dark:text-gray-100 placeholder-gray-400"
        autocomplete="off"
        spellcheck="false"
      />
      <kbd
        class="hidden sm:inline-flex items-center px-2 py-1 text-xs font-medium text-gray-500 bg-gray-100 dark:bg-dark-700 dark:text-gray-400 rounded"
      >
        Esc
      </kbd>
    </div>

    <!-- Results List -->
    <div id="palette-results" class="max-h-[60vh] overflow-y-auto p-2">
      <!-- Results will be rendered here by JS -->
    </div>

    <!-- Footer -->
    <div
      class="flex items-center justify-between px-4 py-2 border-t border-gray-200 dark:border-dark-700 text-xs text-gray-500"
    >
      <div class="flex items-center gap-4">
        <span class="flex items-center gap-1">
          <kbd class="px-1.5 py-0.5 bg-gray-100 dark:bg-dark-700 rounded">â†‘</kbd
          >
          <kbd class="px-1.5 py-0.5 bg-gray-100 dark:bg-dark-700 rounded">â†“</kbd
          >
          to navigate
        </span>
        <span class="flex items-center gap-1">
          <kbd class="px-1.5 py-0.5 bg-gray-100 dark:bg-dark-700 rounded">â†µ</kbd
          >
          to select
        </span>
      </div>
      <a
        href={`${BASE_URL}/troubleshooting/`}
        class="text-accent-500 hover:text-accent-600"
      >
        Need help?
      </a>
    </div>
  </div>
</div>

<!-- Inline search data for client-side use -->
<script is:inline define:vars={{ searchIndex, BASE_URL }}>
  window.__PALETTE_DATA__ = { searchIndex, BASE_URL };
</script>

<script>
  function initCommandPalette() {
    const backdrop = document.getElementById("command-palette-backdrop");
    const palette = document.getElementById("command-palette");
    const searchInput = document.getElementById(
      "palette-search"
    ) as HTMLInputElement;
    const resultsContainer = document.getElementById("palette-results");

    if (!backdrop || !palette || !searchInput || !resultsContainer) return;

    const { searchIndex, BASE_URL } = (window as any).__PALETTE_DATA__;
    let selectedIndex = 0;
    let currentResults: any[] = [];

    const categoryLabels: Record<string, string> = {
      page: "Pages",
      feature: "Features",
      faq: "FAQ",
      action: "Quick Actions",
      changelog: "Changelog",
    };

    function open() {
      backdrop.classList.remove("opacity-0", "pointer-events-none");
      palette.classList.remove("hidden");
      palette.classList.add("flex");
      searchInput.focus();
      searchInput.value = "";
      renderResults(searchIndex.slice(0, 10));
      document.body.style.overflow = "hidden";
    }

    function close() {
      backdrop.classList.add("opacity-0", "pointer-events-none");
      palette.classList.add("hidden");
      palette.classList.remove("flex");
      document.body.style.overflow = "";
    }

    function renderResults(items: any[]) {
      currentResults = items;
      selectedIndex = 0;

      if (items.length === 0) {
        resultsContainer.innerHTML = `
          <div class="p-8 text-center text-gray-400">
            No results found
          </div>
        `;
        return;
      }

      // Group by category
      const grouped: Record<string, any[]> = {};
      for (const item of items) {
        const cat = item.category;
        if (!grouped[cat]) grouped[cat] = [];
        grouped[cat].push(item);
      }

      let html = "";
      let globalIndex = 0;

      for (const [category, categoryItems] of Object.entries(grouped)) {
        html += `<div class="mb-2"><div class="px-3 py-1 text-xs font-semibold text-gray-500 uppercase">${categoryLabels[category] || category}</div>`;

        for (const item of categoryItems) {
          const isExternal = item.href.startsWith("http");
          const fullHref = isExternal ? item.href : `${BASE_URL}${item.href}`;

          html += `
            <a 
              href="${fullHref}"
              ${isExternal ? 'target="_blank" rel="noopener noreferrer"' : ""}
              data-index="${globalIndex}"
              class="palette-item flex items-center gap-3 px-3 py-2 rounded-lg cursor-pointer transition-colors ${globalIndex === selectedIndex ? "bg-accent-500/10 text-accent-600 dark:text-accent-400" : "hover:bg-gray-100 dark:hover:bg-dark-700"}"
            >
              <span class="text-xl">${item.icon || "ðŸ“„"}</span>
              <div class="flex-1 min-w-0">
                <div class="font-medium truncate">${item.title}</div>
                <div class="text-xs text-gray-500 truncate">${item.description}</div>
              </div>
              ${isExternal ? '<svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>' : ""}
            </a>
          `;
          globalIndex++;
        }
        html += "</div>";
      }

      resultsContainer.innerHTML = html;
    }

    function updateSelection() {
      const items = resultsContainer.querySelectorAll(".palette-item");
      items.forEach((item, i) => {
        if (i === selectedIndex) {
          item.classList.add(
            "bg-accent-500/10",
            "text-accent-600",
            "dark:text-accent-400"
          );
          item.classList.remove("hover:bg-gray-100", "dark:hover:bg-dark-700");
          (item as HTMLElement).scrollIntoView({ block: "nearest" });
        } else {
          item.classList.remove(
            "bg-accent-500/10",
            "text-accent-600",
            "dark:text-accent-400"
          );
          item.classList.add("hover:bg-gray-100", "dark:hover:bg-dark-700");
        }
      });
    }

    function selectCurrent() {
      const items = resultsContainer.querySelectorAll(".palette-item");
      const selected = items[selectedIndex] as HTMLAnchorElement;
      if (selected) {
        close();
        selected.click();
      }
    }

    // Fuzzy search
    function search(query: string) {
      const q = query.toLowerCase().trim();
      if (!q) {
        renderResults(searchIndex.slice(0, 10));
        return;
      }

      const results = searchIndex
        .filter(
          (item: any) =>
            item.title.toLowerCase().includes(q) ||
            item.description.toLowerCase().includes(q) ||
            item.tags?.some((t: string) => t.toLowerCase().includes(q))
        )
        .slice(0, 15);

      renderResults(results);
    }

    // Event listeners
    searchInput.addEventListener("input", () => search(searchInput.value));

    searchInput.addEventListener("keydown", (e) => {
      switch (e.key) {
        case "ArrowDown":
          e.preventDefault();
          selectedIndex = Math.min(
            selectedIndex + 1,
            currentResults.length - 1
          );
          updateSelection();
          break;
        case "ArrowUp":
          e.preventDefault();
          selectedIndex = Math.max(selectedIndex - 1, 0);
          updateSelection();
          break;
        case "Enter":
          e.preventDefault();
          selectCurrent();
          break;
        case "Escape":
          e.preventDefault();
          close();
          break;
      }
    });

    backdrop.addEventListener("click", close);

    // Global keyboard shortcut
    document.addEventListener("keydown", (e) => {
      // Ctrl+K or Cmd+K
      if ((e.ctrlKey || e.metaKey) && e.key === "k") {
        e.preventDefault();
        open();
      }
    });

    // Click on result item
    resultsContainer.addEventListener("click", (e) => {
      const target = (e.target as HTMLElement).closest(".palette-item");
      if (target) {
        close();
      }
    });

    // Mouse hover on items
    resultsContainer.addEventListener("mousemove", (e) => {
      const target = (e.target as HTMLElement).closest(".palette-item");
      if (target) {
        const index = parseInt(target.getAttribute("data-index") || "0");
        if (index !== selectedIndex) {
          selectedIndex = index;
          updateSelection();
        }
      }
    });
  }

  document.addEventListener("astro:page-load", initCommandPalette);
  initCommandPalette();
</script>
