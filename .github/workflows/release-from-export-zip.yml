name: Release from exported ZIP

on:
  push:
    branches: ["master"]
    paths:
      - "export/TajemnikTV-TajsModded.zip"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Read manifest + upload ZIP to GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          ZIP="export/TajemnikTV-TajsModded.zip"
          test -f "$ZIP" || (echo "Missing $ZIP (czy na pewno jest zacommitowany?)" && exit 1)

          command -v jq >/dev/null 2>&1 || (echo "jq not found" && exit 1)

          MANIFEST="$(git ls-files | grep -E '(^|/)manifest\.json$' | head -n 1)"
          test -n "$MANIFEST" || (echo "No manifest.json found in repo" && exit 1)

          NAMESPACE="$(jq -r '.namespace // empty' "$MANIFEST")"
          NAME="$(jq -r '.name // empty' "$MANIFEST")"
          VER="$(jq -r '.version_number // empty' "$MANIFEST")"

          test -n "$NAME" || (echo "manifest.json: missing .name" && exit 1)
          test -n "$VER"  || (echo "manifest.json: missing .version_number" && exit 1)

          if [ -n "$NAMESPACE" ]; then
            MOD_ID="${NAMESPACE}-${NAME}"
          else
            MOD_ID="${NAME}"
          fi

          SAFE_ID="$(echo "$MOD_ID" | tr ' ' '-' | tr -cd '[:alnum:]._-' )"
          TAG="${SAFE_ID}-v${VER}"

          ASSET_LABEL="TajemnikTV-TajsModded-${VER}.zip"

          echo "Manifest: $MANIFEST"
          echo "Release tag: $TAG"
          echo "Asset label: $ASSET_LABEL"

          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release exists: $TAG -> upload asset (clobber)"
            gh release upload "$TAG" "${ZIP}#${ASSET_LABEL}" --clobber

            # draft -> publish
            IS_DRAFT="$(gh release view "$TAG" --json isDraft --jq '.isDraft')"
            if [ "$IS_DRAFT" = "true" ]; then
              echo "Release is draft -> publishing it"
              gh release edit "$TAG" --draft=false --latest
            fi
          else
            echo "Creating normal release: $TAG"
            gh release create "$TAG" "${ZIP}#${ASSET_LABEL}" \
              --title "${MOD_ID} v${VER}" \
              --notes "Auto release from commit ${GITHUB_SHA}" \
              --target "${GITHUB_SHA}" \
              --latest
          fi
