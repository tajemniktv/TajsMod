name: Draft release from exported ZIP

on:
  push:
    branches: ["master"]
    paths:
      - "export/TajemnikTV-TajsModded.zip"
      - "**/manifest.json"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Read manifest + upload to draft release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          ZIP="export/TajemnikTV-TajsModded.zip"
          test -f "$ZIP" || (echo "Missing $ZIP" && exit 1)

          MANIFEST="$(git ls-files | grep -E '(^|/)manifest\.json$' | head -n 1)"
          test -n "$MANIFEST" || (echo "No manifest.json found" && exit 1)

          NAMESPACE="$(jq -r '.namespace // empty' "$MANIFEST")"
          NAME="$(jq -r '.name // empty' "$MANIFEST")"
          VER="$(jq -r '.version_number // empty' "$MANIFEST")"

          test -n "$NAME" || (echo "manifest.json: missing .name" && exit 1)
          test -n "$VER"  || (echo "manifest.json: missing .version_number" && exit 1)

          if [ -n "$NAMESPACE" ]; then
            MOD_ID="${NAMESPACE}-${NAME}"
          else
            MOD_ID="${NAME}"
          fi

          SAFE_ID="$(echo "$MOD_ID" | tr ' ' '-' | tr -cd '[:alnum:]._-' )"
          TAG="${SAFE_ID}-v${VER}"

          ASSET_LABEL="TajemnikTV-TajsModded-${VER}.zip"

          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release exists: $TAG -> upload (clobber)"
            gh release upload "$TAG" "${ZIP}#${ASSET_LABEL}" --clobber
          else
            echo "Creating pre-release: $TAG"
            gh release create "$TAG" "${ZIP}#${ASSET_LABEL}" \
              --prerelease \
              --title "${MOD_ID} v${VER}" \
              --notes "Auto pre-release from commit ${GITHUB_SHA}"
          fi
