name: Release + Steam Workshop

on:
  push:
    branches: ["master"]
    paths:
      - "export/TajemnikTV-TajsModded.zip"
  workflow_dispatch: {}

jobs:
  prep:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.meta.outputs.tag }}
      title: ${{ steps.meta.outputs.title }}
      version: ${{ steps.meta.outputs.version }}
      changelog: ${{ steps.meta.outputs.changelog }}
    steps:
      - uses: actions/checkout@v6

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Read manifest.json + extract CHANGELOG entry
        id: meta
        shell: bash
        run: |
          set -euo pipefail

          ZIP="export/TajemnikTV-TajsModded.zip"
          test -f "$ZIP" || (echo "Missing $ZIP (czy na pewno jest zacommitowany?)" && exit 1)

          MANIFEST="$(git ls-files | grep -E '(^|/)manifest\.json$' | head -n 1 || true)"
          test -n "$MANIFEST" || (echo "No manifest.json found in repo" && exit 1)

          NAMESPACE="$(jq -r '.namespace // empty' "$MANIFEST")"
          NAME="$(jq -r '.name // empty' "$MANIFEST")"
          VER="$(jq -r '.version_number // empty' "$MANIFEST")"

          test -n "$NAME" || (echo "manifest.json: missing .name" && exit 1)
          test -n "$VER"  || (echo "manifest.json: missing .version_number" && exit 1)

          if [ -n "$NAMESPACE" ]; then
            MOD_ID="${NAMESPACE}-${NAME}"
          else
            MOD_ID="${NAME}"
          fi

          SAFE_ID="$(echo "$MOD_ID" | tr ' ' '-' | tr -cd '[:alnum:]._-' )"
          TAG="${SAFE_ID}-v${VER}"

          echo "tag=$TAG"                 >> "$GITHUB_OUTPUT"
          echo "title=${MOD_ID} v${VER}"  >> "$GITHUB_OUTPUT"
          echo "version=$VER"             >> "$GITHUB_OUTPUT"

          # -------- CHANGELOG extraction --------
          CHANGELOG_FILE="CHANGELOG.md"
          CHANGELOG_NOTE=""

          if [ -f "$CHANGELOG_FILE" ]; then
            # Grab everything after "## [VER] - ..." until next "## [x.y.z]"
            CHANGELOG_NOTE="$(awk -v ver="$VER" '
              BEGIN {found=0}
              $0 ~ "^##[[:space:]]*\\[" ver "\\][[:space:]]*-" {found=1; next}
              found && $0 ~ "^##[[:space:]]*\\[[0-9]" {exit}
              found {print}
            ' "$CHANGELOG_FILE")"

            # Trim leading/trailing blank lines
            CHANGELOG_NOTE="$(printf "%s\n" "$CHANGELOG_NOTE" | sed -e 's/[[:space:]]\+$//' -e :a -e '/^\n*$/{$d;N;ba' -e '}' -e '1{/^$/d;}')"

            # If still effectively empty -> fallback
            if [ -z "$(printf "%s" "$CHANGELOG_NOTE" | tr -d '[:space:]')" ]; then
              CHANGELOG_NOTE=""
            fi
          fi

          if [ -z "$CHANGELOG_NOTE" ]; then
            CHANGELOG_NOTE="Update v${VER}\n\n(No CHANGELOG entry found for this version.)"
          fi

          # Safety: keep it not-crazy-long for Steam change notes
          CHANGELOG_NOTE="$(printf "%s" "$CHANGELOG_NOTE" | head -c 7000)"

          # Multiline output for GitHub Actions
          {
            echo "changelog<<EOF"
            echo "$CHANGELOG_NOTE"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

  github_release:
    runs-on: ubuntu-latest
    needs: [prep]
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6

      - name: Create/Update GitHub Release (normal release)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail

          ZIP="export/TajemnikTV-TajsModded.zip"
          test -f "$ZIP" || (echo "Missing $ZIP" && exit 1)

          TAG="${{ needs.prep.outputs.tag }}"
          TITLE="${{ needs.prep.outputs.title }}"
          VER="${{ needs.prep.outputs.version }}"
          NOTES="${{ needs.prep.outputs.changelog }}"

          ASSET_NAME="TajemnikTV-TajsModded-${VER}.zip"

          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release exists: $TAG -> upload asset (clobber)"
            gh release upload "$TAG" "${ZIP}#${ASSET_NAME}" --clobber

            # Update release notes too (in case you changed CHANGELOG later)
            gh release edit "$TAG" --notes "$NOTES" --title "$TITLE"
          else
            echo "Creating release: $TAG"
            gh release create "$TAG" "${ZIP}#${ASSET_NAME}" \
              --title "$TITLE" \
              --notes "$NOTES" \
              --target "$GITHUB_SHA" \
              --latest
          fi

  steam_workshop:
    runs-on: ubuntu-latest
    needs: [prep, github_release]
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6

      - name: Stage Workshop payload (zip only)
        shell: bash
        run: |
          set -euo pipefail
          rm -rf workshop_upload
          mkdir -p workshop_upload
          cp "export/TajemnikTV-TajsModded.zip" "workshop_upload/TajemnikTV-TajsModded.zip"

      - name: Upload to Steam Workshop (steamcmd)
        uses: m00nl1ght-dev/steam-workshop-deploy@v4
        with:
          username: ${{ secrets.STEAM_USERNAME }}
          configVdf: ${{ secrets.STEAM_CONFIG_VDF }}
          path: workshop_upload
          appId: "3606890"
          publishedFileId: "3628222709"
          changeNote: ${{ needs.prep.outputs.changelog }}
